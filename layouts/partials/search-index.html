<!-- We require a page parameter of search=true in order to activate the search
  functionaloity. On other pages, the form submission brings us to the search
  page where the result creation happens. -->
{{- if .Page.Params.search -}}

<!-- JS build process: https://gohugo.io/hugo-pipes/js/ -->

<!-- Index rendering -->
{{ $indexTemplate := resources.Get "js/index.tpl.js" }}
<!-- Index build -->
{{ $index := $indexTemplate | resources.ExecuteAsTemplate "js/index.js" . }}
<!-- SRI hashing: https://gohugo.io/hugo-pipes/fingerprint/ -->
{{ $secureIndex := $index | resources.Fingerprint "sha256" }}
<script
  src="{{ $secureIndex.RelPermalink }}"
  integrity="{{ $secureIndex.Data.Integrity }}"
></script>

<!-- JS Build defines -->
{{ $defines := dict "process.env.NODE_ENV" hugo.Environment }}
<!-- JS Build options. the JSX* options are key to using the lighter weight
"Preact" https://preactjs.com/ rather than the defaults that work for React
specifically. -->
{{ $options := dict "defines" $defines "JSXFactory" "h" "JSXFragment" "Fragment"
"minify" true }}
<!-- per-environment customizations -->
{{ if eq hugo.Environment "development" }}
<!-- In non-production, enable source maps -->
<!-- TODO: Enable always when options other than "inline" are available -->
{{ $options = merge $options (dict "sourcemap" "inline") }} {{ end }}
<!-- Search logic -->
{{ $js := resources.Get "js/search.jsx" | js.Build $options }}
<!-- SRI hashing: https://gohugo.io/hugo-pipes/fingerprint/ -->
{{ $secureJS := $js | resources.Fingerprint "sha256" }}
<script
  src="{{ $secureJS.RelPermalink }}"
  integrity="{{ $secureJS.Data.Integrity }}"
></script>
{{- end -}}
